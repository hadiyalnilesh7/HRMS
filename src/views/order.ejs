<%- include("./layouts/header") %> 
<%- include("./layouts/sidebar") %>

<div class="dashboard-container">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">üõéÔ∏è Room Service & Orders</h2>
      <p class="text-muted mb-0">Manage food orders for guests.</p>
    </div>
  </div>

  <div class="row g-4 justify-content-center">
    <!-- Order Form Section -->
    <div class="col-12 col-xl-7">
      <div class="card sticky-top" style="top: 20px; z-index: 1;">
        <div class="card-header bg-white py-3">
          <h5 class="mb-0"><i class="fa-solid fa-utensils me-2 text-primary"></i> Place New Order</h5>
        </div>
        <div class="card-body">
          <form method="POST" action="/order/addOrder" id="orderForm">
            <!-- Room & Customer Selection -->
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <label class="form-label">Room Number <span class="text-danger">*</span></label>
                <select id="roomSelect" name="room" class="form-select" required>
                  <option value="">-- Select Room --</option>
                  <% if (bookings && bookings.length > 0) { %>
                    <% bookings.forEach(b => { %>
                      <option value="<%= b.room._id %>" data-customer="<%= b.customerName %>">Room <%= b.room.roomNo %></option>
                    <% }) %>
                  <% } %>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">Customer Name <span class="text-danger">*</span></label>
                <input type="text" id="customerNameInput" name="customerName" class="form-control" placeholder="Auto-filled from room" required readonly>
              </div>
            </div>

            <!-- Menu Selection -->
            <div class="mb-4">
              <label class="form-label mb-3">Select Menu Items</label>
              <% if (menu && menu.length > 0) { %>
                <div class="row g-3">
                  <% menu.forEach(item => { %>
                    <div class="col-12 col-md-6">
                      <div class="menu-item-card" onclick="toggleSelection(this)">
                        <input class="menu-checkbox form-check-input mt-0" type="checkbox" name="selectedItems" value="<%= item._id %>" id="item_<%= item._id %>" data-price="<%= item.price %>">
                        <div class="menu-details ms-2">
                          <label class="menu-name mb-0 cursor-pointer" for="item_<%= item._id %>">
                            <%= item.name %>
                          </label>
                          <small class="menu-price">‚Çπ<%= item.price %></small>
                        </div>
                      </div>
                    </div>
                  <% }) %>
                </div>
              <% } else { %>
                <div class="alert alert-warning">No menu items available.</div>
              <% } %>
            </div>

            <!-- Total & Submit -->
            <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded border">
              <div>
                <small class="text-muted d-block uppercase">Total Amount</small>
                <span class="fs-4 fw-bold text-primary">‚Çπ<span id="totalAmount">0</span></span>
              </div>
              <input type="hidden" name="items" id="itemsInput">
              <button type="submit" class="btn btn-primary px-4">
                <i class="fa-solid fa-bell-concierge me-2"></i> Place Order
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Order List Section -->
    <div class="col-12 col-xl-5">
      <!-- Pending Orders -->
      <div class="card mb-4">
        <div class="card-header bg-warning-subtle text-warning-emphasis border-bottom-0 py-3">
          <h5 class="mb-0"><i class="fa-solid fa-clock me-2"></i> Pending Orders</h5>
        </div>
        <div class="card-body p-0">
          <% if (pendingOrders && pendingOrders.length > 0) { %>
            <div class="list-group list-group-flush">
              <% pendingOrders.forEach(o => { %>
                <div class="list-group-item p-3">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                      <span class="badge bg-dark rounded-pill mb-2">Room <%= o.room ? o.room.roomNo : 'N/A' %></span>
                      <h6 class="mb-1"><%= o.customerName %></h6>
                    </div>
                    <span class="fs-5 fw-bold text-primary">‚Çπ<%= o.total %></span>
                  </div>
                  
                  <div class="bg-light p-2 rounded small mb-3 text-muted">
                    <% if (Array.isArray(o.items)) { %>
                      <%= o.items.map(i => `${i.name} (‚Çπ${i.price})`).join(', ') %>
                    <% } else { %>
                      <%= o.items %>
                    <% } %>
                  </div>

                  <form method="POST" action="/order/<%= o._id %>/delivery">
                    <input type="hidden" name="deliveryStatus" value="delivered">
                    <button type="submit" class="btn btn-sm btn-success w-100">
                      <i class="fa-solid fa-check me-1"></i> Mark as Delivered
                    </button>
                  </form>
                </div>
              <% }) %>
            </div>
          <% } else { %>
            <div class="text-center py-4 text-muted">
              <i class="fa-solid fa-check-circle fa-2x mb-2 text-success opacity-50"></i>
              <p class="mb-0">No pending orders!</p>
            </div>
          <% } %>
        </div>
      </div>

      <!-- Delivered Orders -->
      <div class="card">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fa-solid fa-history me-2 text-muted"></i> History</h5>
          
          <form method="GET" action="/order" class="d-flex gap-2">
            <input type="text" name="customerName" class="form-control form-control-sm" placeholder="Customer Name" value="<%= typeof customerName !== 'undefined' ? customerName : '' %>">
            <button type="submit" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-search"></i></button>
          </form>
        </div>
        <div class="card-body p-0">
          <% if (deliveredOrders && deliveredOrders.length > 0) { %>
            <div class="list-group list-group-flush">
              <% deliveredOrders.forEach(o => { %>
                <div class="list-group-item p-3 opacity-75">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <small class="text-success fw-bold text-uppercase"><i class="fa-solid fa-check-double me-1"></i> Delivered</small>
                      <h6 class="mb-1 mt-1"><%= o.customerName %> <small class="text-muted fw-normal">(Room <%= o.room ? o.room.roomNo : 'N/A' %>)</small></h6>
                      <small class="text-muted">
                        <% if (Array.isArray(o.items)) { %>
                            <%= o.items.map(i => i.name).join(', ') %>
                        <% } else { %>
                            <%= o.items %>
                        <% } %>
                      </small>
                    </div>
                    <span class="fw-bold">‚Çπ<%= o.total %></span>
                  </div>
                </div>
              <% }) %>
            </div>
          <% } else { %>
            <div class="p-3 text-center text-muted small">No history found.</div>
          <% } %>
        </div>
      </div>
    </div>

<script>
  // DOM Elements
  const roomSelect = document.getElementById('roomSelect');
  const customerNameInput = document.getElementById('customerNameInput');
  const itemsInput = document.getElementById('itemsInput');
  const totalAmountSpan = document.getElementById('totalAmount');
  const form = document.getElementById('orderForm');

  // Helper to get all checkboxes (they are dynamic)
  // We attach event listener to document to handle clicks but updateOrder iterates them
  
  // Auto-fill customer name when room is selected
  roomSelect.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    const customerName = selectedOption.getAttribute('data-customer');
    customerNameInput.value = customerName || '';
  });

  // Calculate Total & Update Selection Styles
  function updateOrder() {
    const checkboxes = document.querySelectorAll('.menu-checkbox');
    const selectedCheckboxes = Array.from(checkboxes).filter(cb => cb.checked);
    const selectedIds = selectedCheckboxes.map(cb => cb.value);
    itemsInput.value = selectedIds.join(',');

    const total = selectedCheckboxes.reduce((sum, cb) => {
      return sum + parseFloat(cb.getAttribute('data-price') || 0);
    }, 0);

    totalAmountSpan.textContent = total;

    // Update styling manually for browsers that don't support :has or just for robustness
    checkboxes.forEach(cb => {
      const card = cb.closest('.menu-item-card');
      if (cb.checked) {
        card.classList.add('selected');
      } else {
        card.classList.remove('selected');
      }
    });
  }
  
  // Toggle selection when clicking the card (if not clicking checkbox directly)
  function toggleSelection(card) {
    // If the click target appears to be the checkbox or label, let default event bubble
    // But since we have onclick on parent, we need to be careful not to double toggle
    // However, clicking checkbox triggers change event. Clicking card should trigger click on checkbox.
    
    // Actually, simpler approach:
    // The Input is inside the card. If I click the card (but NOT the input), toggle input.
    const checkbox = card.querySelector('input[type="checkbox"]');
    
    // We rely on event bubbling for the checkbox change to call updateOrder
    // But we need to handle the "click background" logic
    // The simplest way is to let the label handle the click for the text. 
    // And for the padding area, we can manually check.
  }

  // Attach change listener to all checkboxes
  document.addEventListener('change', function(e) {
    if (e.target.classList.contains('menu-checkbox')) {
      updateOrder();
    }
  });

  // Since we removed individual listeners in favor of delegation or re-querying:
  // Initial update
  updateOrder();

  // Form Validation
  form.addEventListener('submit', function(e) {
    if (!roomSelect.value) {
      e.preventDefault();
      showCustomAlert('Please select a room', 'Validation Error');
      return false;
    }
    if (!itemsInput.value) {
      e.preventDefault();
      showCustomAlert('Please select at least one menu item', 'Validation Error');
      return false;
    }
  });
</script>

<style>
.cursor-pointer { cursor: pointer; }
</style>

<%- include("./layouts/footer") %>
